---
name: Test Changes

'on':
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *' # Nightly at 2AM UTC
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the code
        uses: actions/checkout@v6

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run shellcheck linting
        run: make lint

  run-quick-k8s:
    needs: lint
    if: ${{ needs.lint.result == 'success' }}
    runs-on: ${{ matrix.os }}
    env:
      SHELL: /bin/bash
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-22.04-arm, ubuntu-24.04, ubuntu-24.04-arm]
        provider: [kind, minikube]
    steps:
      - name: Checkout the code
        uses: actions/checkout@v6

      - name: Run the action with ${{ matrix.provider }}
        uses: ./
        with:
          clusterProvider: ${{ matrix.provider }}
          waitForPodsReady: true
          installOLM: true
          removeDefaultStorageClass: true
          removeControlPlaneTaint: true
          apiServerPort: 6443
          apiServerAddress: 127.0.0.1
          disableDefaultCni: true
