---
name: Test Changes

'on':
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *' # Nightly at 2AM UTC
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the code
        uses: actions/checkout@v6

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run shellcheck linting
        run: make lint

  run-quick-k8s:
    needs: lint
    if: ${{ needs.lint.result == 'success' }}
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.experimental || false }}
    env:
      SHELL: /bin/bash
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-22.04-arm, ubuntu-24.04, ubuntu-24.04-arm]
        provider: [kind, minikube]
        experimental: [false]
        include:
          # macOS Intel tests (experimental)
          - os: macos-15-intel
            provider: kind
            experimental: true
          - os: macos-15-intel
            provider: minikube
            experimental: true
    steps:
      - name: Checkout the code
        uses: actions/checkout@v6

      - name: Run the action with ${{ matrix.provider }}
        uses: ./
        with:
          clusterProvider: ${{ matrix.provider }}
          waitForPodsReady: true
          # Skip OLM, Istio, and cert-manager on macOS due to Colima networking limitations
          installOLM: ${{ !startsWith(matrix.os, 'macos') }}
          installIstio: ${{ !startsWith(matrix.os, 'macos') }}
          istioProfile: minimal
          installCertManager: ${{ !startsWith(matrix.os, 'macos') }}
          removeDefaultStorageClass: true
          removeControlPlaneTaint: true
          apiServerPort: 6443
          apiServerAddress: 127.0.0.1
          disableDefaultCni: true

  # Test local registry functionality
  test-local-registry:
    needs: lint
    if: ${{ needs.lint.result == 'success' }}
    runs-on: ubuntu-24.04
    env:
      SHELL: /bin/bash
    steps:
      - name: Checkout the code
        uses: actions/checkout@v6

      - name: Run the action with local registry
        uses: ./
        with:
          clusterProvider: kind
          installLocalRegistry: true
          localRegistryPort: 5001
          waitForPodsReady: true
          installOLM: false
          installIstio: false

      - name: Verify local registry is running
        run: |
          echo "Checking registry container..."
          docker ps | grep quick-k8s-registry
          echo "Testing registry connectivity..."
          curl -s http://localhost:5001/v2/ || exit 1
          echo "Testing push to registry..."
          docker pull busybox:latest
          docker tag busybox:latest localhost:5001/test-image:latest
          docker push localhost:5001/test-image:latest
          echo "Verifying image in registry..."
          curl -s http://localhost:5001/v2/_catalog | grep test-image
          echo "Local registry test passed!"

  # Test skipping CNI installation (for projects that bring their own CNI)
  test-skip-cni:
    needs: lint
    if: ${{ needs.lint.result == 'success' }}
    runs-on: ubuntu-24.04
    env:
      SHELL: /bin/bash
    steps:
      - name: Checkout the code
        uses: actions/checkout@v6

      - name: Run the action without Calico (bring your own CNI)
        uses: ./
        with:
          clusterProvider: kind
          disableDefaultCni: true
          installCalico: false
          waitForPodsReady: false
          installOLM: false
          installIstio: false

      - name: Verify cluster is created without CNI
        run: |
          echo "Checking cluster nodes..."
          kubectl get nodes
          echo "Verifying no Calico pods exist..."
          if kubectl get pods -n kube-system -l k8s-app=calico-node 2>/dev/null | grep -q calico; then
            echo "ERROR: Calico pods found when installCalico=false"
            exit 1
          fi
          echo "Skip CNI test passed - no Calico installed!"

      - name: Install Calico manually (simulating bring-your-own-CNI)
        run: |
          echo "Installing Calico manually to verify cluster works..."
          kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.31.3/manifests/calico.yaml
          echo "Waiting for Calico pods..."
          kubectl wait --for=condition=ready pod -l k8s-app=calico-node -n kube-system --timeout=120s
          echo "Manual CNI installation successful!"

  # Test custom KIND config
  test-custom-kind-config:
    needs: lint
    if: ${{ needs.lint.result == 'success' }}
    runs-on: ubuntu-24.04
    env:
      SHELL: /bin/bash
    steps:
      - name: Checkout the code
        uses: actions/checkout@v6

      - name: Create custom KIND config
        run: |
          cat > ${{ github.workspace }}/custom-kind-config.yaml << 'EOF'
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          networking:
            apiServerAddress: "127.0.0.1"
            apiServerPort: 6443
            ipFamily: ipv4
            disableDefaultCNI: true
          nodes:
            - role: control-plane
              image: kindest/node:v1.35.0@sha256:452d707d4862f52530247495d180205e029056831160e22870e37e3f6c1ac31f
              extraPortMappings:
                - containerPort: 30000
                  hostPort: 30000
                  protocol: TCP
          EOF
          echo "Custom KIND config created:"
          cat ${{ github.workspace }}/custom-kind-config.yaml

      - name: Run the action with custom KIND config
        uses: ./
        with:
          clusterProvider: kind
          kindConfigPath: ${{ github.workspace }}/custom-kind-config.yaml
          waitForPodsReady: true
          installOLM: false
          installIstio: false

      - name: Verify custom config was used
        run: |
          echo "Checking cluster configuration..."
          kubectl get nodes
          echo "Verifying single node (from custom config)..."
          NODE_COUNT=$(kubectl get nodes --no-headers | wc -l)
          if [ "$NODE_COUNT" -ne 1 ]; then
            echo "ERROR: Expected 1 node from custom config, got $NODE_COUNT"
            exit 1
          fi
          echo "Custom KIND config test passed!"

  # Test input validation
  test-input-validation:
    needs: lint
    if: ${{ needs.lint.result == 'success' }}
    runs-on: ubuntu-24.04
    env:
      SHELL: /bin/bash
    steps:
      - name: Checkout the code
        uses: actions/checkout@v6

      - name: Test invalid installCalico value (should fail)
        id: test-invalid-calico
        continue-on-error: true
        uses: ./
        with:
          clusterProvider: kind
          installCalico: invalid-value

      - name: Verify invalid installCalico was rejected
        run: |
          if [ "${{ steps.test-invalid-calico.outcome }}" = "success" ]; then
            echo "ERROR: Invalid installCalico value should have failed"
            exit 1
          fi
          echo "Input validation test passed!"

  # Test cert-manager installation
  test-cert-manager:
    needs: lint
    if: ${{ needs.lint.result == 'success' }}
    runs-on: ubuntu-24.04
    env:
      SHELL: /bin/bash
    steps:
      - name: Checkout the code
        uses: actions/checkout@v6

      - name: Run the action with cert-manager
        uses: ./
        with:
          clusterProvider: kind
          installCertManager: true
          waitForPodsReady: true
          installOLM: false
          installIstio: false

      - name: Verify cert-manager is running
        run: |
          echo "Checking cert-manager namespace..."
          kubectl get namespace cert-manager
          echo "Checking cert-manager pods..."
          kubectl get pods -n cert-manager
          echo "Verifying all cert-manager pods are running..."
          kubectl wait --for=condition=ready pod --all -n cert-manager --timeout=60s
          echo "Checking cert-manager CRDs..."
          kubectl get crd | grep cert-manager
          echo "cert-manager installation verified!"

      - name: Test cert-manager functionality with self-signed issuer
        run: |
          echo "Creating a self-signed ClusterIssuer..."
          cat <<EOF | kubectl apply -f -
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: selfsigned-issuer
          spec:
            selfSigned: {}
          EOF
          echo "Waiting for ClusterIssuer to be ready..."
          kubectl wait --for=condition=ready clusterissuer/selfsigned-issuer --timeout=60s
          echo "cert-manager functionality test passed!"

  # Test ingress-nginx installation
  test-ingress-nginx:
    needs: lint
    if: ${{ needs.lint.result == 'success' }}
    runs-on: ubuntu-24.04
    env:
      SHELL: /bin/bash
    steps:
      - name: Checkout the code
        uses: actions/checkout@v6

      - name: Run the action with ingress-nginx
        uses: ./
        with:
          clusterProvider: kind
          installIngressNginx: true
          waitForPodsReady: true
          installOLM: false
          installIstio: false

      - name: Verify ingress-nginx is running
        run: |
          echo "Checking ingress-nginx namespace..."
          kubectl get namespace ingress-nginx
          echo "Checking ingress-nginx pods..."
          kubectl get pods -n ingress-nginx
          echo "Verifying controller is ready..."
          kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=60s
          echo "Checking IngressClass..."
          kubectl get ingressclass
          echo "ingress-nginx installation verified!"

  # Test custom cluster name
  test-cluster-name:
    needs: lint
    if: ${{ needs.lint.result == 'success' }}
    runs-on: ubuntu-24.04
    env:
      SHELL: /bin/bash
    steps:
      - name: Checkout the code
        uses: actions/checkout@v6

      - name: Run the action with custom cluster name
        uses: ./
        with:
          clusterProvider: kind
          clusterName: my-test-cluster
          waitForPodsReady: true
          installOLM: false
          installIstio: false

      - name: Verify custom cluster name
        run: |
          echo "Checking cluster name..."
          CLUSTERS=$(kind get clusters)
          echo "KinD clusters: $CLUSTERS"
          if ! echo "$CLUSTERS" | grep -q "my-test-cluster"; then
            echo "ERROR: Expected cluster 'my-test-cluster' not found"
            exit 1
          fi
          echo "Verifying kubectl context..."
          CONTEXT=$(kubectl config current-context)
          echo "Current context: $CONTEXT"
          if [[ "$CONTEXT" != *"my-test-cluster"* ]]; then
            echo "ERROR: Expected context to contain 'my-test-cluster', got '$CONTEXT'"
            exit 1
          fi
          echo "Custom cluster name test passed!"

  # Test worker node labels
  test-worker-node-labels:
    needs: lint
    if: ${{ needs.lint.result == 'success' }}
    runs-on: ubuntu-24.04
    env:
      SHELL: /bin/bash
    steps:
      - name: Checkout the code
        uses: actions/checkout@v6

      - name: Run the action with worker node labels
        uses: ./
        with:
          clusterProvider: kind
          numWorkerNodes: 2
          workerNodeLabels: "node-role.kubernetes.io/worker=worker,env=test"
          waitForPodsReady: true
          installOLM: false
          installIstio: false

      - name: Verify worker node labels
        run: |
          echo "Checking worker node labels..."
          WORKER_NODES=$(kubectl get nodes --no-headers -l '!node-role.kubernetes.io/control-plane' -o custom-columns=':metadata.name')
          for NODE in $WORKER_NODES; do
            echo "Checking labels on $NODE..."
            LABELS=$(kubectl get node "$NODE" --show-labels --no-headers | awk '{print $NF}')
            if ! echo "$LABELS" | grep -q "node-role.kubernetes.io/worker=worker"; then
              echo "ERROR: Label 'node-role.kubernetes.io/worker=worker' not found on $NODE"
              exit 1
            fi
            if ! echo "$LABELS" | grep -q "env=test"; then
              echo "ERROR: Label 'env=test' not found on $NODE"
              exit 1
            fi
            echo "  Labels verified on $NODE"
          done
          echo "Worker node labels test passed!"

  # Test metrics-server installation
  test-metrics-server:
    needs: lint
    if: ${{ needs.lint.result == 'success' }}
    runs-on: ubuntu-24.04
    env:
      SHELL: /bin/bash
    steps:
      - name: Checkout the code
        uses: actions/checkout@v6

      - name: Run the action with metrics-server
        uses: ./
        with:
          clusterProvider: kind
          installMetricsServer: true
          waitForPodsReady: true
          installOLM: false
          installIstio: false

      - name: Verify metrics-server is running
        run: |
          echo "Checking metrics-server pod..."
          kubectl get pods -n kube-system -l k8s-app=metrics-server
          echo "Waiting for metrics API to be available..."
          sleep 30
          echo "Testing kubectl top nodes..."
          kubectl top nodes || echo "Metrics may need more time to populate"
          echo "metrics-server installation verified!"
